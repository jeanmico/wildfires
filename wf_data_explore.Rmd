---
title: "Wildfires - data exploration"
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries, Globals, Functions

```{r echo=FALSE}
library('lubridate')
library('tidyverse')
library('ggplot2')
library('epitools')
library('broom')
library(pROC)
```

Name our output files consistently
```{r file naming}

fp_base <<- '/Volumes/Padlock/wildfires/'
fp_defs <<- paste(fp_base, 'defs/', sep = '')
fp_data <<- paste(fp_base, 'data/', sep = '')
fp_exp <<- paste(fp_base, 'exposure/', sep = '')
fp_out <- paste(fp_base, 'output/', sep = '')
#fp_out <<- '~/wildfires/output/'
fp_img <- paste(fp_base, 'images/', sep = '')
#fp_img <<- '~/wildfires/images/'

image_name <- function(fname) {
  return(paste(fp_img, Sys.Date(), '_', fname, '.png', sep = ''))
}

output_name <- function(fname) {
  return(paste(fp_out, Sys.Date(), '_', fname, '.csv', sep = ''))
}

```

```{r time overlap}

time_overlap <- function(df, varname, noexp_value) {
  
  triweeks = 12
  tridays = triweeks*7

  if (noexp_value ==TRUE) {
    tmpstart = ymd(fire_start) - 365
    tmpintvl =  as.interval(fire_length, tmpstart)
  
  } else {
   tmpintvl = fire_intvl 
  }
  
  df <- df %>% mutate(tri1 = as.interval(make_difftime(days = tridays), start_date),
                              tri2 = case_when(int_end(tri1) + days(tridays) < baby_DOB ~
                                                 as.interval(make_difftime(days = tridays), int_end(tri1)),
                                               TRUE ~ interval(int_end(tri1), baby_DOB)),
                              tri3 = interval(int_end(tri2), baby_DOB)
                              )
  
  print(tmpintvl)
  #return(df)
  # determine each trimester's overlap with the fire
  df <- df %>% mutate(overlap1 = if_else(int_overlaps(tri1, tmpintvl), as.duration(lubridate::intersect(tri1, tmpintvl)), 0),
                      overlap2 = if_else(int_overlaps(tri2, tmpintvl), as.duration(lubridate::intersect(tri2, tmpintvl)), 0),
                      overlap3 = if_else(int_overlaps(tri3, tmpintvl), as.duration(lubridate::intersect(tri3, tmpintvl)), 0))
  
  # determine which trimester has the greatest overlap with the fire
  cols = c('overlap1', 'overlap2', 'overlap3')
  df <- df %>% mutate(!!varname := case_when(
    overlap1 == 0 & overlap2 == 0 & overlap3 == 0 ~ '',
    TRUE ~ cols[max.col(df %>% dplyr::select(all_of(cols)))]
        ))
  
  if (!noexp_value) {
    # add the total overlap in days
    df <- df %>% mutate(total_overlap_days = if_else(
      preg_fire_ovrlp, as.numeric(lubridate::intersect(tmpintvl, preg_intvl), 'days'), 0))
  }
  df <- df %>% dplyr::select(-c(tri1, tri2, tri3, overlap1, overlap2, overlap3))
  
  return(df)
  }

```


```{r trimester overlap}
# this function determines the trimester with the greatest overlap of the fire period. If the pregnancy DOES NOT overlap with the fire period, this variable is blank. 

# A second variable is created which is populated regardless of fire overlap. If the pregnancy overlapped the fire, this variable is the same as the previous. If it did not, this variable indicates what trimester the pregnancy was in during the same dates (nov 9 to nov 21) in 2017.

trimester_overlap <- function(births_df) {
  # create first variable
  tmpdf <- time_overlap(births_df, 'exposure_tri', FALSE)
  
  tmpdf <- time_overlap(tmpdf, 'nonexposure_tri', TRUE)
  
  tmpdf <- tmpdf %>% mutate(tri_summary = case_when(
    exposure_tri != '' ~ exposure_tri, 
    nonexposure_tri != '' ~ nonexposure_tri,
    TRUE ~ '')
    )
  
  return(tmpdf)
  
  }

```

```{r contingency table}
cont_tbl <- function(df, tri, tert) {

  tmpdf <- df %>% filter(tri_summary == tri & tertile_exp == tert)
  
  tst <- epitable(tmpdf$binary_exposed, tmpdf$outcome)
  
  tmpepi = epitab(tst, method = 'riskratio')
  
  write.csv(tmpepi$tab, file = output_name(paste(tri, 'tertile', tert, sep = '_')), row.names = FALSE)
  return(data.frame(t(tmpepi$tab[2,])))
}

```

```{r test train split}
testtrain = function(df) {
  df = df %>% mutate(testset = rbinom(n = nrow(df), size = 1, prob = .25))
  return(df)
  }

```


```{r crude associations}


```

```{r loglinear}
loglin <- function(df, expvar, full, fire_only) {
  # df <- df %>% filter(train == TRUE)
  tmpmdl = glm(outcome ~ . , data = df, family = 'poisson')
  
  tmpdf = tidy(tmpmdl)
  
  if (fire_only == TRUE) {
    write.csv(tmpdf, file = output_name(paste('loglinear_fire', expvar, sep = '_')), row.names = FALSE)
  } else{
    write.csv(tmpdf, file = output_name(paste('loglinear', expvar, full, sep = '_')), row.names = FALSE)
    }
  }

```



Define our covariates (globally)
```{r covariates}

partcov <<- c("outcome", "race", "ipi", "edu", "insurance", "pn_care", "wic", "mom_age"
              )

fullcov <<- c(partcov, "mental_disorder", "preexist_diabetes", "preexist_HTN", 'nulliparous', 'drug_abuse', 'alcohol_abuse', 'gest_diabetes', 'gest_HTN')

```

Start processing
```{r}
raw_data = read.csv(paste(fp_data,'birth_file_bayarea2021-09-08.csv', sep = ''))

births <- raw_data
# filter out any births here:

# restrict to singletons
births <- births %>% filter(PLURALITY_16 == 1)

# gestational weeks must be known
n_all = nrow(births)
births = births %>% filter(!is.na(gest_weeks))
n_gest = nrow(births)
print(n_all - n_gest)





```

Rename variables for convenience and readability
```{r rename vars}
decodes = read.csv(paste(fp_defs,'data_dict.csv', sep = ''))

dropcols <- decodes %>% filter(varname == '') %>% dplyr::select(rawname) # drop unneeded columns
births_tmp <- births %>% dplyr::select(-(dropcols$rawname))

keepcols <- decodes%>% filter(varname != '')
# create a named vector to use with dplyr::rename
name_vec <- keepcols$rawname
names(name_vec) <- keepcols$varname

births_tmp <- births_tmp %>% dplyr::rename(name_vec[name_vec %in% names(births_tmp)])

births_tmp <- births_tmp %>% mutate(male = case_when(female == 0 ~1, TRUE~0))

births <- births_tmp
```

```{r set NA values to 0}
# this is how the data are coded

# set nulliparous NA values to 0 (this is how the data are coded)
births = births %>% mutate(nulliparous = case_when(nulliparous == 1 ~ 1, TRUE ~ 0),
                           mental_disorder = case_when(mental_disorder == 1 ~ 1, TRUE ~ 0),
                           preexist_diabetes = case_when(preexist_diabetes == 1 ~ 1, TRUE ~ 0),
                           preexist_HTN = case_when(preexist_HTN == 1 ~ 1, TRUE ~  0),
                           drug_abuse = case_when(drug_abuse == 1 ~ 1, TRUE ~  0),
                           alcohol_abuse = case_when(alcohol_abuse == 1 ~ 1, TRUE ~  0),
                           gest_diabetes = case_when(gest_diabetes == 1 ~ 1, TRUE ~  0),
                           gest_HTN = case_when(gest_HTN == 1 ~ 1, TRUE ~  0))

```

Condense multiple binary columns into factors:
```{r}

factor_defs = read.csv(paste(fp_defs, 'factor_defs.csv', sep = ''))
factor_comps = read.csv(paste(fp_defs, 'factor_components.csv', sep = ''))

fact_cols = factor_defs$factname

births_tmp <- births

for (myfact in fact_cols) {
  fact_default <- filter(factor_defs, factname == myfact)$default
  print(myfact)
  
  births_tmp[myfact] = fact_default
  
  components <- filter(factor_comps, factname == myfact)$varname
  
  for (colname in components)({
    coldata=births_tmp[,colname]
    births_tmp[[myfact]][which(coldata==1)]=colname
    })
  
  mylevels <- c(fact_default, components)
  mylevels = mylevels[!duplicated(mylevels)]
  
  # convert the column to a factor and set the default
  births_tmp[[myfact]] <- factor(births_tmp[[myfact]], levels = mylevels)
}

births <- births_tmp
```

Apply a filter by gestational week: gestational weeks must be known, and <=41; add preterm birth flag
```{r add outcomes}

births = births %>% filter(gest_weeks < 42)
births <- births %>% mutate(preterm = case_when(
  gest_weeks < 37 ~ 1,
  TRUE ~ 0))
births <- births %>% mutate(pt_vearly = case_when(gest_weeks <= 28 ~ 1, TRUE ~ 0),
                            pt_early = case_when(gest_weeks >28 & gest_weeks <=32 ~ 1, TRUE ~ 0),
                            pt_mid = case_when(gest_weeks < 36 & gest_weeks > 32 ~ 1, TRUE ~ 0),
                            pt_late = case_when(gest_weeks < 38 & gest_weeks > 35 ~ 1, TRUE ~0))

births <- births %>% mutate(pt_subtime = case_when(
  preterm == 0 ~ 0,
  gest_weeks < 28 ~ 3, 
  gest_weeks < 36 & gest_weeks > 28 ~ 2,
  TRUE ~ 3))
```

```{r define outcome}
myoutcome = 'preterm'
births <- births %>% mutate(outcome = births[[myoutcome]]) %>% filter(outcome == 1 | preterm == 0)

fp_out <<- paste(fp_out, myoutcome, '', sep = '')
fp_img <<- paste(fp_img, myoutcome, '', sep = '')
```

Determine the start of the pregnancy (baby birth date - gestational weeks)
```{r}
births <- births %>% mutate(baby_DOB = mdy(baby_DOB)) %>%
  mutate(start_date = ymd(baby_DOB) - weeks(gest_weeks))
```

Define the fire period
```{r}

fire_start <<- '2018-11-09'
fire_length <<- make_difftime(days = 12) 
fire_intvl <<- as.interval(fire_length, ymd(fire_start))
fire_end <<- int_end(fire_intvl)

births <- births %>% mutate(preg_intvl = as.interval(make_difftime(weeks = gest_weeks), start_date))

births <- births %>% mutate(preg_fire_ovrlp = int_overlaps(preg_intvl, fire_intvl))

births <- births %>% mutate(binary_exposed = case_when(
  ymd(fire_start) %within% preg_intvl & ymd(fire_end) %within% preg_intvl ~ TRUE,
  TRUE ~ FALSE
))

```

We need to avoid a fixed cohort bias. We do this by choosing a conception date cutoff such that we see the delivery of infants of all gestational ages. In other words, 42 weeks prior to 2019-12-31. Additionally, we consider that pregnancies conceived after the fire to be "exposed." Finally, we must also eliminate any pregnancies that were already at term by the time the smoke event started.
```{r}
cutoff_date = ymd('2019-12-31') - make_difftime(weeks = 42)

births <- births %>% filter(start_date < cutoff_date)
```

More time filtering: our control group is people who delivered before the fire. Finally, we must also eliminate any pregnancies that were already at term by the time the smoke event started.
```{r time filtering}
# remove births conceived after the smoke period

births_tmp <- births %>% mutate(keep_date = case_when(
  start_date >= fire_end ~ FALSE,
  TRUE ~ TRUE))

births_tmp <- births_tmp %>% filter(keep_date)

# pregnancies which were exposed AFTER they had reached 37 weeks
term_length =  make_difftime(weeks = 37)

births_tmp <- births_tmp %>% mutate(keep_date = case_when(
  ymd(fire_start) - term_length >= start_date & binary_exposed == TRUE ~ FALSE,
  TRUE ~ TRUE
  ))

births_tmp <- births_tmp %>% filter(keep_date == TRUE)
births_tmp <- births_tmp %>% filter(x != 0)
births <- births_tmp
```

Determine the length of exposure in each trimester and which trimester has the greatest length of exposure.

```{r trimester overlap}
births_tmp = births
births_tmp = trimester_overlap(births_tmp)
births_tmp = births_tmp %>% filter(tri_summary != '') # restricting our control group to those pregnant in Nov 2017 or 2018
births_tmp <- births_tmp %>% filter(total_overlap_days %in% c(0, 12))
births <- births_tmp
```

```{r half trimesters overlap}
births <- births %>% mutate(halftri_exp = case_when(binary_exposed == TRUE ~ 
                                                      as.numeric(.5*(ceiling(difftime(ymd(fire_start), ymd(start_date), unit = "weeks")/6) + 1)),
                                                    TRUE ~ 0)) %>% 
  mutate(halftri_exp = case_when(halftri_exp == 4 ~ 3.5, halftri_exp == 0.5 ~ 1, TRUE ~ halftri_exp))

births <- births %>% mutate(halftri_non = case_when(binary_exposed == TRUE ~ 
                                                      as.numeric(5*(ceiling(difftime(ymd('2017-11-09'), ymd(start_date), unit = "weeks")/6) + 1)),
                                                    TRUE ~ 0)) %>% 
  mutate(halftri_non = case_when(halftri_non == 4 ~ 3.5, TRUE ~ halftri_non))


```

Make an intro table to make sure our results are correct
```{r check work}
library(tableone)
mytab <- CreateTableOne(vars = fullcov, data = births, strata = 'binary_exposed', 
                        factorVars = c('preexist_HTN', 'preexist_diabetes', 'mental_disorder', 'nulliparous', 'gest_HTN', 'gest_diabetes'))

mytab
#write.csv(mytab, file = output_name('tableone'), row.names = FALSE)
print(mytab )
```

What is our overall preterm birth rate?
```{r preterm birth rate}
ptb_rate = nrow(births %>% filter(outcome == 1))/nrow(births)
ptb_rate

```

Merge census tertiles in.
```{r census tertiles}
births_tmp = births
censtert = read.csv(paste(fp_data,'census_tertiles.csv', sep = ''))

births_tmp = births_tmp %>% mutate(geocensus = as.numeric(substr(births_tmp$geoid, 1, 10)))

births_tmp = merge(births_tmp, censtert, by.x = 'geocensus', by.y = 'geonum')
births_tmp <- births_tmp %>% mutate(tertile_exp = case_when(binary_exposed == TRUE ~ firetert,
                                                            TRUE ~ basetert))
births = births_tmp 

# How many census tracts changed tertiles?

nrow(censtert %>% filter(firetert != basetert))
nrow(censtert %>% filter(abs(firetert - censtert) == 2))
```


Make a timeline plot
```{r pressure, echo=FALSE}
births_dateplt <- births %>% arrange(desc(start_date)) %>% mutate(date_order = row_number())

births_dateplt <- births_dateplt %>% mutate(exposure_decode = 
                                              case_when(exposure_tri == 'overlap1' ~ "Trimester 1",
                                                        exposure_tri == 'overlap2' ~ "Trimester 2",
                                                        exposure_tri == 'overlap3' ~ "Trimester 3",
                                                        TRUE ~ "None"))
  

timeplt <- ggplot(births_dateplt, aes(as.Date(start_date), date_order, color=exposure_decode)) +
  geom_crossbar(aes(xmin = as.Date(start_date), xmax = as.Date(baby_DOB)), width = 0.2) +
  #scale_color_manual(values=c("grey", '#003366', '#2c6d62', '#9d78ba', '#daa425', '#923a49')) +
  scale_color_manual(values=c("grey",  '#003061','#8557a8', '#2d7166', '#daa425', '#923a49')) +
  #scale_color_manual(values=c("grey", '#DDAA33', '#004488', '#BB5566', '#daa425', '#923a49')) +  # ok except for orange rectangle
  #scale_color_manual(values=c("grey", '#a56eff', '#005d5d', '#9f1853', '#daa425', '#923a49')) +  # fine
  #scale_color_manual(values=c("grey", '#4477AA', '#CCBB44', '#AA3377', '#daa425', '#923a49')) +  # ugly
  geom_rect(aes(xmin=as.Date(int_start(fire_intvl)), xmax=as.Date(int_end(fire_intvl)), ymin=0, ymax=nrow(births_dateplt)),
              color="orange", alpha=0.007, fill='orange') +
  geom_rect(aes(xmin=as.Date('2017-11-09'), xmax=as.Date('2017-11-21'), ymin=0, ymax=nrow(births_dateplt)),
              color="#6699CC", alpha=0.007, fill='#6699CC') +
  scale_x_date() + 
  xlab('Date') + 
  ylab('Pregnancy') +
  guides(colour = guide_legend(override.aes = list(linetype=c(1,1,1,1), size = 2.2))) + # can't seem to override legend symbol
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(), 
        plot.background=element_blank(), 
        panel.background=element_rect(fill='white'), 
        panel.grid = element_line(color='grey', size=.1)) +
  theme_bw() +
  labs(color="Exposure timing")
  

#timeplt
#ggsave(timeplt, file = image_name('timeplot'), width = 7, height = 5)
```

Due to computational constraints, exposure rasters are calculated on a cluster; exposure values per person are also assigned on the cluster. This code block saves the latitude, longitude, IDs, and dates to a file so we can extract the PM2.5 values at those locations.
```{r lookup geo points}

exposure_calc <- births %>% dplyr::select(VS_unique, x, y, start_date, baby_DOB)
colnames(exposure_calc) <- c("VS_unique", "longitude", "latitude", "start_date", "baby_DOB")
write.csv(exposure_calc, file = output_name('lookup_points'), row.names = FALSE)

```

Add in exposure data.
```{r exposure add}
# Read files
exposure_sum = read.csv(paste(fp_exp,'exposure_sum_all.csv', sep = ''))
exposure_na = read.csv(paste(fp_exp, 'exposure_na_all.csv', sep = ''))
exposure_counts100 = read.csv(paste(fp_exp,'exposure_counts_all100.csv', sep = ''))
exposure_counts50 = read.csv(paste(fp_exp,'exposure_counts_all50.csv', sep = ''))

# Rename variables
exposure_sum <- exposure_sum %>% select(-X) %>% rename(pm25sum = V1)
exposure_na <- exposure_na %>% select(-X) %>% rename(pm25na = V1)
exposure_counts100 <- exposure_counts100 %>% select(-X) %>% rename(pm25count_100 = V1)
exposure_counts50 <- exposure_counts50 %>% select(-X) %>% rename(pm25count_50 = V1)

# merge files
births_tmp <- merge(births, exposure_sum)
births_tmp <- merge(births_tmp, exposure_na)
births_tmp <- merge(births_tmp, exposure_counts100)
births_tmp <- merge(births_tmp, exposure_counts50)
births<- births_tmp

# Calculate mean exposure.
births <- births %>% 
  mutate(pm25mean = pm25sum/(time_length(baby_DOB - start_date, unit = "days") - pm25na))

```

Boxplots of mean exposure, comparing those who were exposed vs those who were not.
```{r exposure violins}
birthsbox = births %>% mutate(Exposed = case_when(
  binary_exposed ~ "Exposed", 
  TRUE ~ "Unexposed"))

meanexp_box = ggplot(birthsbox, aes(x = Exposed, y = pm25mean)) +
                geom_boxplot() + 
  geom_signif(comparisons = list(c('Exposed', 'Unexposed')), map_signif_level = TRUE) +
  #geom_signif( xmin = 1, xmax = 2, y_position = 20) + 
  xlab('Exposed to fire') + 
  ylab('Mean PM2.5 concentration') + 
  theme_bw()

meanexp_box

ggsave(meanexp_box, file = image_name('meanexp_fullpreg_boxplot'), width = 7, height = 5)
```



T-test to evaluate whether there is a difference in pregnancy mean pm2.5 between those who experienced the fire and those who did not.
```{r ttest}


pm25_noexp = births %>% filter(binary_exposed == FALSE)
pm25_exp = births %>% filter(binary_exposed == TRUE)
tt = t.test(pm25_noexp$pm25mean, pm25_exp$pm25mean)

tt

```

Simple 2x2 table: is exposure to the wildfire associated with increased risk of PTB?
```{r}


births_before <- births %>% filter(baby_DOB < ymd(fire_start) | binary_exposed == TRUE)
tst <- epitable(births_before$binary_exposed, births_before$outcome)

epirr = epitab(tst, method = 'riskratio')
write.csv(epirr, file = output_name('crude_binary_risk'), row.names = FALSE)

```

Slightly more complicated table: does the trimester of exposure matter?
```{r 3 trimester table}


tst_3tri <- epitable(births$exposure_tri, births$outcome) 

epitab(tst_3tri)

```

Slightly more complicated table: does the half trimester of exposure matter?
```{r half trimester table}


tst_htri <- epitable(births$halftri_exp, births$outcome) 

epi_htri = data.frame(epitab(tst_htri, method = "riskratio"))
epi_htri$htri = as.numeric(rownames(epi_htri))

write.csv(epi_htri, file = output_name('half_tri_RR'))


htri_risk = ggplot(epi_htri, aes(x = htri, y = tab.riskratio, ymin = tab.lower, ymax = tab.upper)) + 
  geom_pointrange() + 
  geom_hline(yintercept = 1) + 
  ylab("Risk Ratio of Preterm Birth (log scale)") + 
  xlab("Half Trimester") + 
  scale_y_log10() + 
  theme_bw()


htri_risk

ggsave(htri_risk, file = image_name('halftri_RR'))
```

 
 
Model building

test and train split
```{r test and train split}
births <- testtrain(births)
births_trn = births %>% filter(testset == 0)
```

## crude exposures
```{r crude risk ratios}

cont_exp = c('pm25count_50', 'pm25count_100', 'pm25mean', 'binary_exposed')
for (i in 1:length(cont_exp)) {
  mdf = births_trn %>% dplyr::select(outcome, cont_exp[[i]])
  simplecont_exp <- glm(outcome ~  ., data = mdf, family = 'poisson')
  write.csv(tidy(simplecont_exp), file = output_name(paste('loglinear_crude_', cont_exp[[i]], sep = '')), row.names = FALSE)
  }

```

## adjusted exposures

log linear model: outcome is preterm birth (binary), input is covariates

```{r models: all, trimester of exposure}
expvars = c('binary_exposed',  'pm25mean')

for (i in 1:length(expvars)) {
  for (j in c('crude', 'partial', 'full')){
    if (j == 'crude') {
        mdf = births_trn %>% dplyr::select(outcome, expvars[[i]])
        #simplecont_exp <- glm(outcome ~  ., data = mdf, family = 'poisson')
    } else if (j == 'partial') {
      mdf = births_trn %>% dplyr::select(c(all_of(partcov)), expvars[[i]])
    } else {
      mdf = births_trn %>% dplyr::select(c(all_of(fullcov[-9])), expvars[[i]])
  }
    loglin(mdf, expvars[[i]], j, FALSE)
  }
  }

```

# QUESTION 2 ####################
###################################
## Risk by exposure DURING the fire

First, test high fire tertiles against low fire tertiles **in the control group** to determine whether there are significant differences.
```{r high fire vs low fire}
firetertdf = births %>% filter(firetert == 3 | firetert == 1)
firetert_census = unique(firetertdf$geocensus)

compare_control = births %>% filter(geocensus %in% firetert_census & binary_exposed == 0)

compare_tbl <- CreateTableOne(vars = c(fact_cols, 'wic', 'preterm'), data = compare_control, strata = 'firetert', test = TRUE,  factorVars = fact_cols)

compare_tbl

```




Only consider people who were exposed
```{r restricting to exposed}
exp_births <- births %>% filter(binary_exposed)

exp_births <- exp_births %>% mutate(ftert_desc  = case_when(
  firetert == 1 ~ "low",
  firetert == 2 ~ "medium",
  firetert == 3 ~ "high"))

#write.csv(exp_births$VS_unique, file = '/Volumes/Padlock/wildfires/exposure/exposed_ids.csv', row.names = FALSE)

exp_pm_summary = read.csv(paste(fp_exp, 'exp_pm_summary.csv', sep = ''))
exp_births <- merge(exp_births, exp_pm_summary, by = "VS_unique")

exp_births <- exp_births %>% mutate(pm25mean_exp = pm25sum_exp/(time_length(fire_intvl, unit = "days")))


# write simplified exposed births file for mapping
fire_births_map = exp_births %>% dplyr::select(VS_unique, x, y, pm25mean, pm25mean_exp, pm25peak, outcome)

write.csv(fire_births_map, file = '/Volumes/Padlock/wildfires/fire_births_map.csv', row.names = FALSE)
```


```{r fire pm}

firemean_hist = ggplot(exp_births, aes(x = pm25mean_exp)) + 
  geom_histogram() + 
  theme_bw()

firemean_hist


```


```{r fire pm}
hist(exp_births$pm25peak)
firepeak_hist = ggplot(exp_births, aes(x = pm25peak)) + 
  geom_histogram() + 
  theme_bw()

firepeak_hist
```

analysis start

```{r 3 trimester table}

exp_3tri <- epitable(exp_births$exposure_tri, exp_births$outcome, rev = "rows") 

epitab(exp_3tri)

```


```{r tertile table}

firetert_tbl <- epitable(exp_births$ftert_desc, exp_births$outcome)

epitab(firetert_tbl, method = 'riskratio')
```


```{r fire train split}

exp_births = testtrain(exp_births)
exp_births_trn = exp_births %>% filter(testset == 0)

```


```{r models: all, trimester of exposure}
expvars = c('exposure_tri', 'pm25count_50', 'pm25count_100', 'pm25mean', 'pm25peak', 'firemean', 'firetert')

for (i in 1:length(expvars)) {
  mdf = exp_births_trn %>% dplyr::select(c(all_of(partcov)), expvars[[i]])
  loglin(mdf, expvars[[i]], TRUE)
  
  }

```






```{r ftert loglinear}

ftert_log = glm(outcome ~ race + ipi + edu + insurance + pn_care + bmi + wic + preexist_HTN + preexist_diabetes +  firetert, data = exp_births, family = 'poisson')

summary(ftert_log)

```


Comparing high fire tertiles to high baseline tertiles - do we see a difference?
```{r high tertile tracts compare}
tertcomp = births %>% filter(firetert == 3 | basetert == 3) %>% mutate(hightert = case_when(firetert == 3 & basetert == 3 ~ "both",
                                                                                            firetert == 3 ~ "fire", 
                                                                                            TRUE ~ "base"))
terttab = CreateTableOne(vars = c(fact_cols, 'wic', 'preterm'), data = tertcomp, strata = 'hightert', test = TRUE,  factorVars = fact_cols)

terttab

```


```{r median income ttest}
acs = read.csv(paste(fp_data, 'acs_data_5yr_2019.csv', sep = ''))
acs <- acs %>% filter(rename == 'median_income')

tertacs = merge(tertcomp, acs, by.x = "geocensus", by.y = "GEOID")

terthigh_base = tertacs %>% filter(basetert == 3)
terthigh_fire = tertacs %>% filter(firetert == 3)
tthigh = t.test(terthigh_base$estimate, terthigh_fire$estimate)

tthigh


tertlow_base = tertacs %>% filter(basetert == 1)
tertlow_fire = tertacs %>% filter(firetert == 1)
ttlow = t.test(tertlow_base$estimate, tertlow_fire$estimate)

ttlow


```


#ARCHIVE

Histogram comparison of the gestational age between exposed and unexposed.

```{r histogram comparison}
compare_plt = births %>% mutate(unexp_weeks = case_when(binary_exposed == 0 ~gest_weeks)) %>%
  mutate(exp_weeks = case_when(binary_exposed == 1 ~gest_weeks))

nbins_exp = max(compare_plt$exp_weeks, na.rm=TRUE) - min(compare_plt$exp_weeks, na.rm=TRUE)
nbins_unexp = max(compare_plt$unexp_weeks, na.rm=TRUE) - min(compare_plt$unexp_weeks, na.rm=TRUE)

compare_hist <-ggplot(compare_plt, aes(x=x) ) +
  geom_histogram( aes(x = unexp_weeks), fill="#69b3a2", bins=nbins_unexp, alpha = .8 ) +
  geom_histogram( aes(x = exp_weeks), fill= "#404080", bins=nbins_exp, alpha = .8) +
  xlab("Pregnancy duration in gestational weeks") +
  theme_bw()

compare_hist

ggsave(compare_hist, file = image_name('comparison_hist'))

```

Plot: pregnancy duration by conception date
```{r pregnancy duration by conception}

preg_duration <- ggplot(births, aes(x = as.Date(start_date), y = gest_weeks, color=binary_exposed)) +
  geom_point() +
  theme_bw() +
  scale_x_date()


preg_duration

ggsave(preg_duration, file='~/wildfires/images/duration_by_start_date.png')
```
