---
title: "Wildfires - data exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r echo=FALSE}
library('lubridate')
library('tidyverse')
```

```{r}
base_addresses = read.csv('/Volumes/Padlock/wildfires/birth_file_bayarea2021-02-01.csv')

# filter out any births here:
# restrict to singletons
```

Our sample size is `r nrow(base_addresses)`. Counties included: Alameda, 

# Exploratory figures

Remove or correct NA values
```{r}
births = births %>% filter(!is.na(gest_weeks))
```


Apply a filter by gestational week: gestational weeks must be known, and <=41
```{r}

births = births %>% filter(gest_weeks < 42)
```

Determine the start of the pregnancy (baby birth date - gestational weeks)
```{r}
births <- base_addresses %>% mutate(baby_DOB = mdy(baby_DOB)) %>%
  mutate(start_date = ymd(baby_DOB) - weeks(gest_weeks))
```

Define the fire period
```{r}
# this definition of the fire interval may change as the project continues
fire_start = '2018-11-01'
fire_length = make_difftime(days = 30) 

fire_intvl = as.interval(fire_length, ymd(fire_start))

births <- births %>% mutate(preg_intvl = as.interval(make_difftime(weeks = gest_weeks), start_date))

births <- births %>% mutate(preg_fire_ovrlp = int_overlaps(preg_intvl, fire_intvl))

table(births$preg_fire_ovrlp)
```

Determine the length of exposure in each trimester and which trimester has the greatest length of exposure.
```{r}

triweeks = 12
tridays = triweeks*7


births <- births %>% mutate(tri1 = as.interval(make_difftime(days = tridays), start_date),
                            tri2 = case_when(int_end(tri1) + days(tridays) < baby_DOB ~
                                               as.interval(make_difftime(days = tridays), int_end(tri1)),
                                             TRUE ~ interval(int_end(tri1), baby_DOB)),
                            tri3 = interval(int_end(tri2), baby_DOB)
                            )


# determine which trimester has the greatest overlap with the fire
births <- births %>% mutate(overlap1 = case_when(int_overlaps(tri1, fire_intvl) ~ 
                                                   as.duration(intersect(tri1, fire_intvl)),
                                                 TRUE ~ 0),
                            overlap2 = case_when(int_overlaps(tri2, fire_intvl) ~ 
                                                   as.duration(intersect(tri2, fire_intvl)),
                                                 TRUE ~ 0),
                            overlap3 = case_when(int_overlaps(tri3, fire_intvl) ~ 
                                                   as.duration(intersect(tri3, fire_intvl)),
                                                 TRUE ~ 0) )

# determine which trimester has the greatest overlap with the fire
cols = c('overlap1', 'overlap2', 'overlap3')
births <- births %>% mutate(exposure_tri = case_when(
  overlap1 == 0 & overlap2 == 0 & overlap3 == 0 ~ '',
  TRUE ~ cols[max.col(births %>% dplyr::select(all_of(cols)))]
      ))

```

Make a plot that 
```{r pressure, echo=FALSE}
births_dateplt <- births %>% arrange(desc(start_date)) %>% mutate(date_order = row_number())

timeplt <- ggplot(births_dateplt, aes(as.Date(start_date), date_order, color=exposure_tri)) +
  geom_crossbar(aes(xmin = as.Date(start_date), xmax = as.Date(baby_DOB)), width = 0.2) +
  scale_color_manual(values=c("grey", '#003366', '#2c6d62', '#9d78ba', '#daa425', '#923a49')) +
  geom_rect(aes(xmin=as.Date(int_start(fire_intvl)), xmax=as.Date(int_end(fire_intvl)), ymin=0, ymax=Inf),
              color="orange", alpha=0.007, fill='orange') +
  scale_x_date()
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}
ggsave(timeplt, file = '/Volumes/Padlock/wildfires/timeplot.png')


```

Simple 2x2 table
```{r}
library(epitools)
```

Test a very simple logistic regression model: outcome is preterm birth (binary), input is covariates and binary trimester exposure.

```{r}


```
